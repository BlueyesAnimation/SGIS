<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SGIS com Apps Script</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 1rem;
      }
      h1 {
        text-align: center;
      }
      nav {
        display: flex;
        justify-content: space-around;
        margin-bottom: 1rem;
      }
      nav button {
        flex: 1;
        margin: 0 0.25rem;
        padding: 0.5rem;
        font-size: 1rem;
        cursor: pointer;
      }
      .view {
        display: none;
      }
      .view.active {
        display: block;
      }
      .form-group {
        margin-bottom: 0.5rem;
      }
      .form-group label {
        display: block;
        margin-bottom: 0.25rem;
      }
      .form-group input {
        flex: 1;
        padding: 0.4rem;
        font-size: 1rem;
        width: 100%;
      }
      .status {
        margin-top: 0.5rem;
        padding: 0.5rem;
        background-color: #e9ecef;
        border-radius: 4px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
      }
      th, td {
        border: 1px solid #ccc;
        padding: 0.5rem;
        text-align: left;
      }
      th {
        background-color: #f0f0f0;
      }
      /* Modal for scanner */
      #scannerModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        justify-content: center;
        align-items: center;
        z-index: 999;
      }
      #scannerModal video {
        width: 90%;
        max-width: 400px;
        border: 4px solid #fff;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>SGIS (Google Apps Script)</h1>
      <nav>
        <button id="btnEntrada">Entrada</button>
        <button id="btnSaida">Saída</button>
        <button id="btnConsulta">Consulta</button>
        <button id="btnExport">Exportar</button>
      </nav>
      <div id="entradaView" class="view active">
        <h2>Entrada de Stock</h2>
        <div class="form-group">
          <label for="entradaCodigo">Código de barras</label>
          <input type="text" id="entradaCodigo" />
          <button id="scanEntrada">Scan</button>
        </div>
        <div class="form-group">
          <label for="entradaNome">Nome do Produto</label>
          <input type="text" id="entradaNome" />
        </div>
        <div class="form-group">
          <label for="entradaPreco">Preço Unitário (€)</label>
          <input type="number" id="entradaPreco" step="0.01" />
        </div>
        <div class="form-group">
          <label for="entradaQuantidade">Quantidade</label>
          <input type="number" id="entradaQuantidade" step="1" />
        </div>
        <button id="btnAddEntrada">Adicionar Entrada</button>
      </div>
      <div id="saidaView" class="view">
        <h2>Saída de Stock</h2>
        <div class="form-group">
          <label for="saidaCodigo">Código de barras</label>
          <input type="text" id="saidaCodigo" />
          <button id="scanSaida">Scan</button>
        </div>
        <div class="form-group">
          <label for="saidaQuantidade">Quantidade</label>
          <input type="number" id="saidaQuantidade" step="1" />
        </div>
        <button id="btnAddSaida">Registar Saída</button>
      </div>
      <div id="consultaView" class="view">
        <h2>Consulta de Stock</h2>
        <div class="form-group">
          <label for="consultaBusca">Buscar por código ou nome</label>
          <input type="text" id="consultaBusca" />
          <button id="scanConsulta">Scan</button>
        </div>
        <table id="consultaTabela">
          <thead>
            <tr>
              <th>Código</th>
              <th>Nome</th>
              <th>Preço Unitário (€)</th>
              <th>Quantidade</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="exportView" class="view">
        <h2>Exportar Inventário</h2>
        <button id="btnDownloadCSV">Exportar para CSV</button>
      </div>
      <div class="status" id="status"></div>
    </div>

    <!-- Scanner modal -->
    <div id="scannerModal">
      <video id="preview"></video>
    </div>

    <!-- ZXing library -->
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.21.3/umd/index.min.js"></script>
    <script>
      // --- Configuration ---
      // Replace WEB_APP_URL with the deployment URL of your Apps Script Web App.
      const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyMcTuyVMqRZ4S7KoAgr70BoEe8PrWp1nEZTh6qAODUqJA4KbdBNnYTmFbl-WjpT4fh/exec';

      // Local storage keys
      const STORAGE_PRODUCTS_KEY = 'sgis_products';
      const STORAGE_MOVEMENTS_KEY = 'sgis_movements';

      // State
      let products = [];
      let movements = [];
      let selectedInput = null; // input to fill after scanning

      // Initialize application
      document.addEventListener('DOMContentLoaded', () => {
        loadData();
        updateProductTable();
        updateStatus();

        // Navigation buttons
        document.getElementById('btnEntrada').addEventListener('click', () => showView('entradaView'));
        document.getElementById('btnSaida').addEventListener('click', () => showView('saidaView'));
        document.getElementById('btnConsulta').addEventListener('click', () => showView('consultaView'));
        document.getElementById('btnExport').addEventListener('click', () => showView('exportView'));

        // Entrada events
        document.getElementById('btnAddEntrada').addEventListener('click', addEntrada);
        document.getElementById('scanEntrada').addEventListener('click', () => startScan('entradaCodigo'));

        // Saída events
        document.getElementById('btnAddSaida').addEventListener('click', addSaida);
        document.getElementById('scanSaida').addEventListener('click', () => startScan('saidaCodigo'));

        // Consulta events
        document.getElementById('consultaBusca').addEventListener('input', updateProductTable);
        document.getElementById('scanConsulta').addEventListener('click', () => startScan('consultaBusca'));

        // Export events
        document.getElementById('btnDownloadCSV').addEventListener('click', exportCSV);

        // Online/offline events
        window.addEventListener('online', () => {
          updateStatus();
          syncDataToServer();
        });
        window.addEventListener('offline', updateStatus);
      });

      // Show a specific view
      function showView(viewId) {
        document.querySelectorAll('.view').forEach(view => {
          view.classList.remove('active');
        });
        document.getElementById(viewId).classList.add('active');
      }

      // Load data from localStorage
      function loadData() {
        try {
          const storedProducts = localStorage.getItem(STORAGE_PRODUCTS_KEY);
          products = storedProducts ? JSON.parse(storedProducts) : [];
        } catch (e) {
          products = [];
        }
        try {
          const storedMovements = localStorage.getItem(STORAGE_MOVEMENTS_KEY);
          movements = storedMovements ? JSON.parse(storedMovements) : [];
        } catch (e) {
          movements = [];
        }
      }

      // Save data to localStorage
      function saveData() {
        localStorage.setItem(STORAGE_PRODUCTS_KEY, JSON.stringify(products));
        localStorage.setItem(STORAGE_MOVEMENTS_KEY, JSON.stringify(movements));
      }

      // Add entry
      function addEntrada() {
        const codigo = document.getElementById('entradaCodigo').value.trim();
        const nome = document.getElementById('entradaNome').value.trim();
        const preco = parseFloat(document.getElementById('entradaPreco').value);
        const quantidade = parseInt(document.getElementById('entradaQuantidade').value, 10);
        if (!codigo || !nome || isNaN(preco) || isNaN(quantidade) || quantidade <= 0) {
          alert('Preencha todos os campos de entrada correctamente.');
          return;
        }
        let product = products.find(p => p.codigo === codigo);
        if (!product) {
          product = { codigo, nome, preco, quantidade: 0 };
          products.push(product);
        }
        product.nome = nome;
        product.preco = preco;
        product.quantidade += quantidade;
        movements.push({ data: new Date().toISOString(), tipo: 'Entrada', codigo, quantidade, utilizador: 'Local' });
        saveData();
        updateProductTable();
        clearEntradaForm();
        updateStatus();
        if (navigator.onLine) {
          syncDataToServer();
        }
      }

      function clearEntradaForm() {
        document.getElementById('entradaCodigo').value = '';
        document.getElementById('entradaNome').value = '';
        document.getElementById('entradaPreco').value = '';
        document.getElementById('entradaQuantidade').value = '';
      }

      // Add exit
      function addSaida() {
        const codigo = document.getElementById('saidaCodigo').value.trim();
        const quantidade = parseInt(document.getElementById('saidaQuantidade').value, 10);
        if (!codigo || isNaN(quantidade) || quantidade <= 0) {
          alert('Preencha o código e a quantidade correctamente.');
          return;
        }
        const product = products.find(p => p.codigo === codigo);
        if (!product) {
          alert('Produto não encontrado.');
          return;
        }
        if (product.quantidade < quantidade) {
          alert('Quantidade insuficiente em stock.');
          return;
        }
        product.quantidade -= quantidade;
        movements.push({ data: new Date().toISOString(), tipo: 'Saída', codigo, quantidade, utilizador: 'Local' });
        saveData();
        updateProductTable();
        clearSaidaForm();
        updateStatus();
        if (navigator.onLine) {
          syncDataToServer();
        }
      }

      function clearSaidaForm() {
        document.getElementById('saidaCodigo').value = '';
        document.getElementById('saidaQuantidade').value = '';
      }

      // Update product table
      function updateProductTable() {
        const tbody = document.querySelector('#consultaTabela tbody');
        tbody.innerHTML = '';
        const searchTerm = document.getElementById('consultaBusca').value.trim().toLowerCase();
        products
          .filter(p => {
            return (
              p.codigo.toLowerCase().includes(searchTerm) ||
              p.nome.toLowerCase().includes(searchTerm)
            );
          })
          .sort((a, b) => a.codigo.localeCompare(b.codigo))
          .forEach(p => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${p.codigo}</td><td>${p.nome}</td><td>${p.preco.toFixed(2)}</td><td>${p.quantidade}</td>`;
            tbody.appendChild(tr);
          });
      }

      // Export to CSV (only products for inventory)
      function exportCSV() {
        if (products.length === 0) {
          alert('Não há produtos para exportar.');
          return;
        }
        const header = ['Código', 'Nome', 'Quantidade', 'Preço Unitário (€)'];
        const rows = products.map(p => [p.codigo, p.nome, p.quantidade, p.preco.toFixed(2)]);
        let csvContent = header.join(',') + '\n';
        rows.forEach(row => {
          csvContent += row.map(item => '"' + item.replace(/"/g, '""') + '"').join(',') + '\n';
        });
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const now = new Date();
        const fileName = `Inventario_${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}.csv`;
        a.download = fileName;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Update status indicator
      function updateStatus() {
        const status = document.getElementById('status');
        if (navigator.onLine) {
          status.textContent = 'Online';
        } else {
          status.textContent = 'Offline (as alterações serão sincronizadas quando houver ligação)';
        }
      }

      // Synchronize data to Apps Script backend
      function syncDataToServer() {
        if (!WEB_APP_URL || WEB_APP_URL.startsWith('REPLACE_WITH')) {
          // Web app URL not configured
          console.warn('WEB_APP_URL não definido. Configure o URL de implantação do Apps Script.');
          return;
        }
        // Prepare payload: convert product and movements arrays to arrays of arrays
        const produtosValues = products.map(p => [p.codigo, p.nome, p.preco, p.quantidade]);
        const movimentosValues = movements.map(m => [m.data, m.tipo, m.codigo, m.quantidade, m.utilizador]);
        fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ produtos: produtosValues, movimentos: movimentosValues })
        })
          .then(response => response.json())
          .then(data => {
            console.log('Sync response:', data);
            document.getElementById('status').textContent = 'Sincronizado com o servidor';
          })
          .catch(err => {
            console.error('Erro ao sincronizar:', err);
            document.getElementById('status').textContent = 'Erro na sincronização';
          });
      }

      // Barcode scanning using ZXing
      function startScan(inputId) {
        selectedInput = document.getElementById(inputId);
        const modal = document.getElementById('scannerModal');
        const previewElem = document.getElementById('preview');
        modal.style.display = 'flex';
        const codeReader = new ZXing.BrowserMultiFormatReader();
        codeReader
          .listVideoInputDevices()
          .then(videoInputDevices => {
            const firstDeviceId = videoInputDevices[0]?.deviceId;
            codeReader.decodeFromVideoDevice(firstDeviceId, 'preview', (result, err) => {
              if (result) {
                selectedInput.value = result.getText();
                stopScan(codeReader);
              }
            });
          })
          .catch(err => {
            console.error(err);
            alert('Erro ao aceder à câmara: ' + err.message);
            stopScan(codeReader);
          });
        // Clicking outside the video stops the scan
        modal.addEventListener('click', () => {
          stopScan(codeReader);
        });
      }

      function stopScan(codeReader) {
        const modal = document.getElementById('scannerModal');
        modal.style.display = 'none';
        try {
          codeReader.reset();
        } catch (e) {
          // ignore
        }
      }
    </script>
  </body>
</html>